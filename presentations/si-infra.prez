---
layout: presentation
title: Les infrastructures informatiques
presenter: true
permalink: /presentations/si-infra.html
---
       
???
Prérequis :
* Machine linux avec telnet, dig, openssl, gpg

---
title: why
class: center, middle, inverse

# :'(

???
# Pourquoi tant de haine ?!?
* Découvrir les méthodes de sécurisation des protocols historisques d'internet comme HTTP, SMTP...
* Exemple sur les mails (mise en place récente)
* Découvrir quelques technos du web comme les DNS...
* Parler un peu de crypto
* Découvrir SSL/TLS/x509
* Découvrir GPG
* Elargir le web-of-trust

---
title: c'est quoi un mail 
class: center, middle, inverse

# C'est quoi un mail ?

???
On en utilise tous les jours, mais sait-on vraiment ce que c'est ?

---
layout: true
class: left, top, normal

---
# C'est quoi un mail 

```
  Received: from 31.121.118.45 (EHLO serveur.fr)
            by mta1007.mail.ukl.yahoo.com with SMTP; Fri, 21 Sep 2012 21:31:16 +0000
  Received: by serveur.fr (Postfix, from userid 106)
            id 3DF2F15A0CD; Fri, 21 Sep 2012 23:31:16 +0200 (CEST)
  From: "Thomas" <thomas@serveur.fr>
  To: david@yahoo.fr
  Subject: Bonjour !
  Date: Fri, 21 Sep 2012 23:31:16 +0200
  MIME-Version: 1.0
  Content-Transfer-Encoding: 8bit
  Content-Type: text/plain; charset=iso-8859-1
  X-Mailer: Mozilla Thunderbird
  Message-Id: <20120921212116.3DF2F16A0CD@serveur.fr>

  Bonjour David,
  Tiens-moi au courant pour la réunion.
  Thomas
```
Source : [Wikipedia](http://fr.wikipedia.org/wiki/Courrier_%C3%A9lectronique)

???

Un message **textuel** en ASCII (7bits) envoyé par un **émetteur** à un **destinataire**

```
Source : [Wikipedia](http://fr.wikipedia.org/wiki/Courrier_%C3%A9lectronique)
```
---
layout: true
class: left, top, normal

---
# Routage
## DNS

* Association d'un nom de domaine avec une adresse IP
* Base de donnée distribuée et hierarchique

.prezTable[
    <table>
        <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Class</th>
            <th>TTL</th>
            <th>Data</th>
        </tr>
        <tr>
            <td>sogelink.fr.</td>
            <td>A</td>
            <td>IN</td>
            <td>180</td>
            <td>86.66.19.110</td>
        </tr>
        <tr>
            <td>sogelink.fr.</td>
            <td>SOA</td>
            <td>IN</td>
            <td>3600</td>
            <td>a.ns.certilience.fr. nsadmin.sogelink.fr. 1421330078 28800 7200 604800 3600</td>
        </tr>
        <tr>
            <td>sogelink.fr.</td>
            <td>NS</td>
            <td>IN</td>
            <td>259200</td>
            <td>a.ns.certilience.fr.</td>
        </tr>
        <tr>
            <td>sogelink.fr.</td>
            <td>MX</td>
            <td>IN</td>
            <td>180</td>
            <td>11 mx11.dict.fr.</td>
        </tr>
        <tr>
            <td>www</td>
            <td>CNAME</td>
            <td>IN</td>
            <td>75263</td>
            <td>vip110.dc.certilience.com.</td>
        </tr>
        <tr>
            <td>sogelink.fr.</td>
            <td>TXT</td>
            <td>IN</td>
            <td>3600</td>
            <td>"v=spf1 +mx ip4:78.40.74.32/28 ip4:176.31.234.24 ip4:178.33.9.63 -all"</td>
        </tr>
    </table>
]

???
* A : Adresse IPv4
* AAAA: Adresse IPv6
* CNAME: Alias
* MX: Mail Server
* NS: Name Server
* SOA: autorité locale
* TXT: Texte

Hiérarchie des DNS : NS de . puis NS de .fr. puis NS de .sogelink.fr. ...

* Sécurisation possible grâce à DNSSec (utilisation de la crypto asymétrique pour signer les enregistrement DNS)

Outil : dig 

---
title: securisation
class: center, middle, inverse

# Sécurisation des mails

???

* Autenticité : qui a envoyé
* Confidentialité : qui peut le lire

---
# Assurer la confidentialité
## 7 couches du modèle OSI

.prezTable[
    <table>
        <thead>
            <tr>
                <th>level</th>
                <th>Layer</th>
                <th>Application</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>7</td>
                <td>Application Layer</td>
                <td>HTTP, FTP, DNS, <b>SMTP</b></td>
            </tr>
            <tr>
                <td>6</td>
                <td>Présentation Layer</td>
                <td><b>SSL, TLS</b></td>
            </tr>
            <tr>
                <td>5</td>
                <td>Session Layer</td>
                <td>NetBios, PPTP, <b>SSL, TLS</b></td>
            </tr>
            <tr>
                <td>4</td>
                <td>Transport Layer</td>
                <td><b>TCP</b>, UDP</td>
            </tr>
            <tr>
                <td>3</td>
                <td>Network Layer</td>
                <td><b>IP</b>, ARP, ICMP, IPSec</td>
            </tr>
            <tr>
                <td>2</td>
                <td>Data Link Layer</td>
                <td>PPP, ATM, <b>Ethernet</b></td>
            </tr>
            <tr>
                <td>1</td>
                <td>Physical Layer</td>
                <td><b>Ethernet</b>, USB, Bluetooth</td>
            </tr>
        </tbody>
    </table>
]

???

## L'architecture en 7 couche du modèle OSI
* Protocols internet sur couche 7
* Sécurisation sur couche 5/6

---
# Assurer la confidentialité
## SSL et TLS

> Transport Layer Security (TLS) and its predecessor, Secure Sockets Layer (SSL), are **cryptographic protocols** designed to provide communication security over the Internet.
> <br/><br/>
> They use **X.509 certificates** and hence **asymmetric cryptography** to authenticate the counterparty with whom they are communicating, and to **exchange a symmetric key**.
> <br/><br/>
> This session key is then used to **encrypt data flowing between the parties**. This allows for **data/message confidentiality** \[...\] and as a by-product, **message authentication**.

Source : [Wikipedia](http://en.wikipedia.org/wiki/Transport_Layer_Security)

???

Protocoles cryptographique
* Basé sur X.509 (hein ?)
* et la crypto asymétrique (hein ?)
* Pour échanger une clé symétrique (re-re-hein ?)
* Pour finalement tout crypter entre les deux

Objectif :
* Confidentialité
* Authentification

---
# Assurer la confidentialité
## Cryptographie symétrique

![Symmetric-key algorithm](/images/Symmetric-key algorithm.svg)

???

Une seule clé sert à chiffrer et déchiffrer.
* Algorithme de César (décalage de caaractères A->C, B->D...)
* XOR (application d'un masque XOR bit à bit)
* Twofish
* AES
* RC4
* 3DES

RC4 encore très utilisé dans TLS, mais déconseillé à cause de biais possible. Probablement cassé par les agences crypto.

---
# Assurer la confidentialité
## Cryptographie asymétrique

![Asymmetric-key algorithm](/images/Asymmetric-key algorithm.svg)

???
Deux clés liées mathématiquement (factorisation de nombres premiers, factorisation sur courbes éliptiques) permettent de :
* Chiffrer et déchiffer
* Signer et vérifier

Les deux clés sont interchangeable (avant publication) !

Plein d'algorithms utilisent des clés asymétriques :
* RSA (signature et chiffrement) --> SSH, GPG...
* DSA (signature) -> 
* Diffie-Helmann (échange de clés sécurisé) -> TLS/SSL

---
# Assurer la confidentialité
## SSL et TLS

> Transport Layer Security (TLS) and its predecessor, Secure Sockets Layer (SSL), are **cryptographic protocols** designed to provide communication security over the Internet.
> <br/><br/>
> They use **X.509 certificates** and hence **asymmetric cryptography** to authenticate the counterparty with whom they are communicating, and to **exchange a symmetric key**.
> <br/><br/>
> This session key is then used to **encrypt data flowing between the parties**. This allows for **data/message confidentiality** \[...\] and as a by-product, **message authentication**.

Source : [Wikipedia](http://en.wikipedia.org/wiki/Transport_Layer_Security)

???

Protocoles cryptographique
* Basé sur X.509 (hein ?)
* et la crypto asymétrique (hein ?)
* Pour échanger une clé symétrique (re-re-hein ?)
* Pour finalement tout crypter entre les deux

Objectif :
* Confidentialité
* Authentification

---
# Assurer la confidentialité
## X.509

> In cryptography, X.509 is **an ITU-T standard** for a **public key infrastructure (PKI)** and **Privilege Management Infrastructure (PMI)**. 
> <br/><br/>
> X.509 specifies, amongst other things, **standard formats for public key certificates**, **certificate revocation lists**, **attribute certificates**, and **a certification path validation algorithm**.

Source : [Wikipedia](http://en.wikipedia.org/wiki/X.509)

???

* Définition d'un système de gestion de clé uniquement. Ca ne définit pas d'algorithme ou de protocoles. C'est applicables partout.
* Basé sur de la crypto asymétriques à clé publique/privée
* Utilisé dans SSL/TLS mais pas uniquement, aussi pour la signature du code, des documents PDF...

---
# X.509
## Certificat

Informations sur le certificat
* Serial Number
* Subject
* Subject Public Key
* Issuer
* Validity
* Usages
* Signature

Codé sous forme de clé-valeur avec des identifiants normalisés, des OID :

* 2.5.29.15 - Key Usage
* 1.2.840.113549.1.1.5 : Signature RSA-SHA
* 2.5.29.14 : Subject Key Identifier
* 1.3.6.1.4.1.36513 : Préfix Sogelink

???
* Certificat : Association d'une clée publique et d'une identité (personne).

* Usages : utilisations possibles du certificat.
* Classes de certificats
    * SSL : pas cher
    * SSL wildcard : + cher
    * Authentification personnelle : très cher
    * Signature de code : très cher
    * Extended Validation (cadena vert) : très très cher 

* OID : Object Identifier
* Liste maintenue par l'ISO (International Organisation for Standardisation) et ITU-T (International telecomunication Union - Telecom Standardization Sector)


---
# X.509
## Certificat

* Des formats de certificats
 * DER/CER/CRT : format binaire de certificat basé sur [ASN1](http://lapo.it/asn1js/#3082052D30820415A0030201020203159718300D06092A864886F70D0101050500303C310B300906035504061302555331173015060355040A130E47656F54727573742C20496E632E311430120603550403130B526170696453534C204341301E170D3134313030353038313932315A170D3137313030373136343334355A3081BC31293027060355040513204A50344A476F36523064416459533149784D6666686241547169396E65364E4C31133011060355040B130A475439383638333335353131302F060355040B1328536565207777772E726170696473736C2E636F6D2F7265736F75726365732F637073202863293134312F302D060355040B1326446F6D61696E20436F6E74726F6C2056616C696461746564202D20526170696453534C2852293116301406035504030C0D2A2E736F67656C696E6B2E667230820122300D06092A864886F70D01010105000382010F003082010A0282010100BA9AB3936606D1D4CECB669F3BEB9D3A978266B15E8FF1E2CCBCF0EEAD3680BEAE0AFA591953709CD2A639FDF527062456109E637586335EFD41B9F27676A7AB507D214B9BC27D8F09673957F1D36C556B289A0B09AA834D16B8A05F6ED661902EF80B0395E0DDF13A19682C5154DAE5BC70A80DAB27BB4A7C5C25CCA34E6C59F0B562165AB3B025D5BC9DBF5A3840D0A1EC45F2AFD0CAAE332A8D0417A10CEECB2B2DCF4F129240EB2081BAB4CA975402881AC1DEBEDACE5420E01341F60CDBD27368C68B02F7F684376DD362E07E86AD52E7F3E021F3C7DBBD70FC836B4D41ACE1A7AB67F700E175FD3FBEA4F71192D8E2A027365C3A17E9A22FDE116F69A30203010001A38201B5308201B1301F0603551D230418301680146B693D6A18424ADD8F026539FD35248678911630300E0603551D0F0101FF0404030205A0301D0603551D250416301406082B0601050507030106082B0601050507030230250603551D11041E301C820D2A2E736F67656C696E6B2E6672820B736F67656C696E6B2E667230430603551D1F043C303A3038A036A0348632687474703A2F2F726170696473736C2D63726C2E67656F74727573742E636F6D2F63726C732F726170696473736C2E63726C301D0603551D0E04160414BDA8932EC2EB251205403C24AD16E4983F67977A300C0603551D130101FF04023000307806082B06010505070101046C306A302D06082B060105050730018621687474703A2F2F726170696473736C2D6F6373702E67656F74727573742E636F6D303906082B06010505073002862D687474703A2F2F726170696473736C2D6169612E67656F74727573742E636F6D2F726170696473736C2E637274304C0603551D20044530433041060A6086480186F8450107363033303106082B060105050702011625687474703A2F2F7777772E67656F74727573742E636F6D2F7265736F75726365732F637073300D06092A864886F70D0101050500038201010053FAAF73BCD7E02864A7C32ED30E66D7935B44D78DECC93C7F303DA997609C847EAE9A13455E96EC9D7403D6B1C8B7DC48E4E6B20035F0FCC4F83153D02BB0A0C7DCAE49B1E9B09925B8A4CE94BD73AF7C67B864A77BBDA21E3DBBF4F45FD4A39D046B9F5B87F51EE827BAFB2C244EDC2F887900D59DA9205F6C9A9F3DE4BCFF785BC32F3F6636BEFF695280411584F73FFB738D10520E1B239305D280F0EAF269BB9FF03A6BD30099FB8C7ACCF61E2E192B4044D1A667E16DC12B24667EA9B6FEF1C62C288B58510F0B29A6ED1CF8661315630E957B489FF47F033BF082336276DADDE404260B44231A00A57E84302735E92D6EA2342DC5D1C027A887F4173E)
 * PEM : DER encodé en base64 (utilisé pour la communication d'un fichier DER)
 * PKCS7 : Format de signature pouvant contenir le certificat public
 * PKCS12 : Format de conteneur de clés publiques et privées protégé par mot de passe

---
# X.509
## Modèle de confiance des autorités de certification

![Certification Authority Trust Model](/images/Certification Authority Trust Model.svg)

???

* Environ 500 certificats installé dans Ubuntu (root et intermédiaires)
* Une 50 de Root CA sur les OS/navigateurs
* 5 gros acteurs pour les certificats SSL mais des centaines d'AC intermédiaires
* Des revendeurs sur les AC des gros
* Tous les logiciels n'ont pas la même liste (Adobe != OS, CaCert sur certains linux...)

---
# X.509
## Hierarchie des certificats

### Exercice : Trouver le root CA du certificat Sogelink

--
* Equifax Secure Certificate Authority
    * GeoTrust Global CA
        * RapidSSL CA
            * *.sogelink.fr

???
* Geotrust a racheté la branche sécurité d'un organisme bancaire (Equifax). Il a depuis été acquis par Verisign.
* RapidSSL est un revendeur sur la PKI de verisign...
* Verisign appartient à Symantec qui a 35% du marché (5 acteur pour 95 des cert)

---
# X.509
## Révocation

```
  Certificate Revocation List (CRL):
      Version 2 (0x1)
    Signature Algorithm: sha1WithRSAEncryption
      Issuer: /C=US/O=Google Inc/CN=Google Internet Authority G2
      Last Update: Jan 25 01:00:03 2015 GMT
      Next Update: Feb  4 01:00:03 2015 GMT
      CRL extensions:
        X509v3 Authority Key Identifier: 
          keyid:4A:DD:06:16:1B:BC:F6:68:B5:76:F5:81:B6:BB:62:1A:BA:5A:81:2F
        X509v3 CRL Number: 
          617
  Revoked Certificates:
*   Serial Number: 0D2AF612383ADA5C
*     Revocation Date: Jul  9 07:58:39 2014 GMT
*     CRL entry extensions:
*       X509v3 CRL Reason Code: 
*         Key Compromise
      [...]
  Signature Algorithm: sha1WithRSAEncryption
     17:4c:0d:fc:47:61:fd:02:ef:d7:11:f7:23:e3:45:db:72:15:
     [...]

```


???
Exemple de CRL visualisée avec openssl crl

Publication par les autorités de certification (CA), d'une liste de révocation contenant tous les numéro de série des certificats révoqués avec la raison et la date.

La vérification est normalement obligatoire, mais elle est rarement obligatoire.

---
# Assurer la confidentialité
## SSL et TLS


1. Etablissement du tunnel TCP
2. → **Client Hello** (version SSL, algo supportés et random du client)
3. ← **Server Hello** (version SSL, algo supportés et random du serveur)
3. ← **Server Certificate** (chaine de certificat serveur)
3. ← **Server Hello Done**
4. _Verification du certificat du serveur_
5. _Creation d'un secret premaster chiffré avec la clé publique du serveur_
6. → **Client Certificate** + secret premaster chiffré
7. _Calcul de la clé symétrique (premaster+randoms)_
8. → **Client Finished** (message "client" chiffré avec la clé symétrique)
9. ← **Server Finished** (message "server" chiffré avec la clé symétrique)
11. _Echange de données chiffrées symétriquement_


???
* Version courte du bouzin complet
* Possibilité d'avoir de l'identification du client plus forte
* Possibilité d'un mode anonyme (on ne s'envois que les clés publiques, pas les certificats complets
* Possibilités de renégociation
* Différents algorithmes de calcul du master (clé symétrique)
* Perfect Forward Secrecy !


---
# Assurer la confidentialité
## SSL et TLS

### Démo : SMTP sur TLS

```
  openssl s_client -starttls smtp -connect server.werlen.fr:465
```


???
* Se connecter sur server.werlen.fr
* Montrer la hierarchie des certificats
* Montrer la session résultante

---
# L'acheminement

![Schéma de l'acheminement d'un mail par Wikipedia](http://upload.wikimedia.org/wikipedia/commons/8/8c/Etapes_envoi_email.png)
Source : [Wikipedia](http://commons.wikimedia.org/wiki/File:Etapes_envoi_email.png)

???

* Toute la chaine n'est pas sécurisée !
* On sait qui a envoyé le message, mais tout le monde peut lire son contenu
* Confidentialité entre les SMTP (si pris en charge) et vers le client
* Pas de confidentialité sur les serveurs ! Le serveur a le message en clair et peut le renvoyer en clair

---
# Assurer la confidentialité
## Chiffrement GPG

```
    From: Maxime Werlen <mwerlen@server.werlen.fr>
    To: maxime@werlen.fr
    Subject: Message chiffre avec GPG
    Content-Type: text/plain; charset=us-ascii; x-action=pgp-encrypted
    
*   -----BEGIN PGP MESSAGE-----
*   Version: GnuPG v1
*   
*   hQEMAz9clsGeCsjzAQgApIDt2mLrj93E4e2j3F7i9BhmBdhYPtS+pGDNziwN8Gcg
*   pqeFT29/E5P5UH/Jn0HYMy6mI1zEGsWZ59Mucly0nsptHlnZHmq7cWDtTn50h1L8
*   D8oHbaNLI1DW0ghZvTF1Pb0ybVf+3+79XJRZn5507jVqesG3jmMHP98eAIOn9EvM
*   2JGztj3gvcuSI30QpwwU1LANpphqnqF0JM4x3yU62jjbwG7WKPagtETPGcU8e7GF
*   CYWG0KAzM4layHw/q/aObq1p3VY18WsgmzHawAtnR9CUEBYWg4MN2O0ERORqQ5Gs
*   qzsjFD362c46JIgN9sdQm7mOQGXdxei8rJW+jgKfytKMAaN0bTSnBrspiSJkYf7y
*   k4yN1botJTz5hIhy1PfRdiMlo5YKuE3DrD6lHosRrwi9Zd2rF92Ialw/5FM15L13
*   TCd9LWSufLM8Blpe0Qb90p3mZu011WWjPdB33aKtMfbt1TblCBojIr0XekmXeNCs
*   rSoUj+pyKWj2McUo8TFa/R7rqKqeb+MeaSxNIo4=
*   =o6js
*   -----END PGP MESSAGE-----
```

???

* Message chiffré par l'utilisateur avec la clé publique du destinataire.
* Seul le destinataire pourra le déchiffrer
* Cumulable avec la signature
* Plusieurs formats possible (inline ou PGP/MIME)

---
# GPG

## Fonctionnement

> Pretty Good Privacy (PGP) is a data encryption and decryption **computer program** that provides cryptographic **privacy** and **authentication** for data communication.
> <br/><br/>
> PGP is often used for **signing**, **encrypting**, and **decrypting** texts, e-mails, files, directories, and whole disk partitions and to increase the security of e-mail communications

Source : [Wikipedia](http://en.wikipedia.org/wiki/Pretty_Good_Privacy)

???

* Pas un protocol, ni algorithme. C'est un logiciel de chiffrement et signature à clé asymétrique.
* Gestion de la confidentialité et de l'authentification
* Gestion de la clé privée et de son utilisation
* pas de x.509 pour gérer la confiance et les formats...

---
title: end
class: center, middle, inverse

# The end

---
layout: true
class: left, top, normal

---
# Sources

## Préparation du BBL


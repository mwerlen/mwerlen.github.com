---
layout: post
title: SchemaCrawler pour extraire la structure d&apos;une base de donn&eacute;e
date: 2011-04-22
comments: false
categories : [archives]
tags: []
---

<em><a href="http://schemacrawler.sourceforge.net/">SchemaCrawler </a></em>est un framework open-source de découverte de base de données sur jdbc. Il permet de récupérer facilement les métadonnées de la base étudiée. Le framework est aussi publié sous forme d'outil indépendant à utiliser en ligne de commande. Il permet par exemple <a href="http://mindbuffer.wordpress.com/2010/10/14/schema-crawler/">d'extraire un fichier de description d'une base</a>.<br /><em>SchemaCrawler </em>permet ainsi de récupérer les informations suivantes :<br /><ul><li>Liste des <a href="http://en.wikipedia.org/wiki/Database_catalog">catalogs</a>&nbsp;(rarement utilisés)</li><li>Liste des <a href="http://en.wikipedia.org/wiki/Database_schema">schémas</a></li><li>Liste des tables, vues, routines, triggers, contraintes...</li><li>Liste et détails des champs</li></ul><h1><span style="font-size: large;">Une recherche en deux étapes</span></h1>La récupération des métadonnées se fait en deux étapes :<br /><ul><li>La définition des options de recherche</li><li>Le lancement de la recherche sur une <em>connection </em>jdbc</li></ul><h2><span style="font-size: small;">Les options de recherche</span></h2>La définition des options de recherche est la phase la plus longue et complexe. Des options mal configurées engendrent des temps de réponse très long et une quantité d'informations inutiles et parasites importante. Il est nécessaire de filtrer tout ce que l'on ne souhaite pas récupérer.<br />Pour filtrer les éléments à conserver, <i>SchemaCrawler</i> met à disposition des objets InclusionRule qui prennent en paramètre une regExp à inclure et une regExp à exclure.<br />Dans l'exemple suivant, nous définissons un objet option de <em>schemaCrawler </em>permettant de ne récupérer aucune table, aucune vue, aucune procédure, aucun champ... Ainsi nous ne récupérons que la liste des schémas/catalogs de la base.<br /><pre>// Création d'un objet option de SchemaCrawler<br />    SchemaCrawlerOptions options = new SchemaCrawlerOptions();<br /><br />    // On n'autorise aucun type de tables (tables, vues...)<br />    TableType[] types = {};<br />    options.setTableTypes(types);<br /><br />    // On exclue toutes les procédures (inclure rien, exclure tout)<br />    InclusionRule procedureInclusionRule = new InclusionRule("", ".*");<br />    options.setProcedureInclusionRule(procedureInclusionRule);<br /><br />    // On exclue toutes les colonnes des procédures (inclure rien, exclure tout)<br />    InclusionRule procedureColumnInclusionRule = new InclusionRule("", ".*");<br />    options.setProcedureColumnInclusionRule(procedureColumnInclusionRule);<br /><br />    // On exclue toutes les tables(inclure rien, exclure tout)<br />    InclusionRule tableInclusionRule = new InclusionRule("", ".*");<br />    options.setTableInclusionRule(tableInclusionRule);<br /><br />    // On fixe le niveau de détail des métadonnées au minimum<br />    options.setSchemaInfoLevel(SchemaInfoLevel.minimum());<br /><br />    // On exclue les procédure stockées<br />    options.setShowStoredProcedures(false);<br /></pre><h2><span style="font-size: small;">Le lancement de la recherche</span></h2>Le lancement de la recherche est la partie la plus simple. Il suffit de faire appel à la méthode&nbsp;<kbd>SchemaCrawlerUtility.getDatabase</kbd> et de passer en paramètre une connexion à la base de données valide (de type&nbsp;<kbd>java.sql.Connection</kbd>) et un objet <em>option </em>de <em>schemaCrawler.</em><br /><pre>Database crawlingDatabase = SchemaCrawlerUtility.getDatabase(databaseConnection, options);<br /></pre>Une fois l'objet <em>database </em>de <em>SchemaCrawler </em>récupéré, il est très simple de parcourir les métadonnées. Par exemple pour tracer la liste des schémas de la base de données :<br /><pre>for (final Schema schema : crawlingDatabase.getSchemas()) {<br />        log.info("Found database schema " + schema.getSchemaName() + " in catalog " + schema.getCatalogName());<br />    }<br /></pre><h1><span style="font-size: large;">Différentes options intéressantes</span></h1>Comme expliqué dans le chapitre précédent, la complexité d'utilisation de ce framework réside principalement dans la configuration de l'objet option permettant de spécifier correctement les informations à remonter pour réduire au maximum les temps de recherche en base (un scan complet de la base étant extrêmement long). Dans cette section, nous allons proposer deux exemples types de définition de l'objet option pour récupérer les schémas puis les tables et vues. Sur le même principe toutes les métadonnées de la base peuvent être récupérées.<br /><h2><span style="font-size: small;">Récupération de la liste des schémas</span></h2>Idem chapitre précédant :<br /><pre>// Création d'un objet option de SchemaCrawler<br />    SchemaCrawlerOptions options = new SchemaCrawlerOptions();<br /><br />    // On n'autorise aucun type de tables (tables, vues...)<br />    TableType[] types = {};<br />    options.setTableTypes(types);<br /><br />    // On exclue toutes les procédures (inclure rien, exclure tout)<br />    InclusionRule procedureInclusionRule = new InclusionRule("", ".*");<br />    options.setProcedureInclusionRule(procedureInclusionRule);<br /><br />    // On exclue toutes les colonnes des procédures (inclure rien, exclure tout)<br />    InclusionRule procedureColumnInclusionRule = new InclusionRule("", ".*");<br />    options.setProcedureColumnInclusionRule(procedureColumnInclusionRule);<br /><br />    // On exclue toutes les tables(inclure rien, exclure tout)<br />    InclusionRule tableInclusionRule = new InclusionRule("", ".*");<br />    options.setTableInclusionRule(tableInclusionRule);<br /><br />    // On fixe le niveau de détail des métadonnées au minimum<br />    options.setSchemaInfoLevel(SchemaInfoLevel.minimum());<br /><br />    // On exclue les procédure stockées<br />    options.setShowStoredProcedures(false);<br /></pre><h2><span style="font-size: small;">Récupération de la liste des tables et vues</span></h2><pre>// Création d'un objet option de SchemaCrawler<br />    SchemaCrawlerOptions options = new SchemaCrawlerOptions();<br /><br />    // On autorise les tables et les vues<br />    TableType[] types = { TableType.table, TableType.view };<br />    options.setTableTypes(types);<br /><br />    // On exclue toutes les procédures (inclure rien, exclure tout)<br />    InclusionRule procedureInclusionRule = new InclusionRule("", ".*");<br />    options.setProcedureInclusionRule(procedureInclusionRule);<br /><br />    // On exclue toutes les colonnes des procédures (inclure rien, exclure tout)<br />    InclusionRule procedureColumnInclusionRule = new InclusionRule("", ".*");<br />    options.setProcedureColumnInclusionRule(procedureColumnInclusionRule);<br /><br />    // On exclue les procédure stockées<br />    options.setShowStoredProcedures(false);<br /><br />    // On inclue toutes les tables mais on exclue les tables commençant par $ (pour éviter les tables système d'Oracle)<br />    InclusionRule tableInclusionRule = new InclusionRule(".*", ".*[\\x24]+.*");<br />    options.setTableInclusionRule(tableInclusionRule);<br /><br />    // On fixe le niveau de détail des métadonnées au minimum<br />    options.setSchemaInfoLevel(SchemaInfoLevel.minimum());<br /><br />    // On spécifie le schéma que l'on souhaite crawler<br />    InclusionRule schemaInclusionRule = new InclusionRule("MySchema", "");<br />    options.setSchemaInclusionRule(schemaInclusionRule);</pre><pre></pre><pre></pre><pre></pre><i>Article rédigé pour la plateforme de capitalisation technique de&nbsp;</i><a href="http://www.sword-group.com/" target="_blank">Sword</a>